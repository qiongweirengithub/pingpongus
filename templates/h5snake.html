<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>贪吃蛇</title>

    <style type="text/css">
*{margin:0;padding: 0;font-family: "Microsoft YaHei";}
#page{margin-right: auto;margin-left: auto; margin-top: 20px;height: 600px; width: 980px; }
#yard{ width: 800px;border: 1px solid gray;box-shadow: 0 0 10px black; float: right;}
#mark{font-weight: 800;}
#mark_con{ color: red; }
button{width: 50px; }
a{text-decoration:none;}
.bottom{font-size:50; color: blue;text-align: center;margin-bottom: 65 }      
.status{font-size:50; color: blue;text-align: center;margin-bottom: 65 }                

</style>

</head>

<body>




    <div id="page">
        <div id="yard">
            <canvas id="canvas" height="600px" width="800px"></canvas>
        </div>
        <div id="help">
            <div id="mark">得分：<span id="mark_con"></span></div>
        </div>
        <div id="login" class="bottom">
                <span>登录</span>
        </div>
        <div class="input">
                <span>输入房间id:</span>
                <input type="text" id="room_id_input"> </input>
            </div>
            
            <div id="create_room" class="bottom">
                    <span>创建房间</span>
            </div>

            <div id="join_room" class="bottom">
                    <span>加入房间</span>
            </div>


            <div id="start" class="bottom">
                    <span>开始</span>
            </div>

                <div class="status">
                    <span id="player">not login</span>
                </div>

                <div class="status">
                    <span id="room">not room</span>
                </div>

                <div class="status">
                    <span id="my_move">no move</span>
                </div>


    </div>



<script type="text/javascript">
        //伪常量
        var BLOCK_SIZE = 20;        //格子大小
        var COLS = 40;                        //列数
        var ROWS = 30;                        //行数
        var user_id = null;
        var ai_id = null;
        var current_room_id = null; 
        var player = document.getElementById('player');
        var room = document.getElementById('room');
        var my_move = document.getElementById('my_move');
        //变量
        var snakes = [];                //保存蛇坐标
        var c = null;                        //绘图对象
        var toGo = 3;                        //行进方向
        var snakelen = 4;                //蛇身数量
        var interval = null;        //计时器
        var foodX = 0;                        //食物X轴坐标
        var foodY = 0;                        //食物Y轴坐标
        var oMark = null;                //分数显示框
        var isPause = false;        //是否暂停
        websocket = new WebSocket("ws://192.168.1.102:8763/");

        // 绘图函数
        function draw(){
            c.clearRect(0,0,BLOCK_SIZE * COLS, BLOCK_SIZE * ROWS);
            //画出横线
            for( var i = 1; i <= ROWS; i++ ) {
                c.beginPath();
                c.moveTo(0, i * BLOCK_SIZE);
                c.lineTo(BLOCK_SIZE * COLS, i * BLOCK_SIZE);
                c.strokeStyle = "gray";
                c.stroke();
            }
            //画出竖线
            for(var i = 1; i <= COLS; i++){
                c.beginPath();
                c.moveTo(i * BLOCK_SIZE, 0);
                c.lineTo(i * BLOCK_SIZE, BLOCK_SIZE * ROWS);
                c.stroke();
            }
            //画出蛇
            for (var i = 0; i < snakes.length; i++){
                c.beginPath();
                c.fillStyle = "green";
                c.fillRect(snakes[i].x, snakes[i].y, BLOCK_SIZE, BLOCK_SIZE);
                c.moveTo(snakes[i].x, snakes[i].y);
                c.lineTo(snakes[i].x + BLOCK_SIZE, snakes[i].y);
                c.lineTo(snakes[i].x + BLOCK_SIZE, snakes[i].y + BLOCK_SIZE);
                c.lineTo(snakes[i].x, snakes[i].y + BLOCK_SIZE);
                c.closePath();
                c.strokeStyle = "red";
                c.stroke();
            }
            //画出食物
            c.beginPath();
            c.fillStyle = "yellow";
            c.fillRect(foodX, foodY, BLOCK_SIZE, BLOCK_SIZE);
            c.moveTo(foodX, foodY);
            c.lineTo(foodX + BLOCK_SIZE, foodY);
            c.lineTo(foodX + BLOCK_SIZE, foodY + BLOCK_SIZE);
            c.lineTo(foodX, foodY + BLOCK_SIZE);
            c.closePath();
            c.strokeStyle = "red";
            c.stroke();
        }
        //游戏初始化
        function start(){
            snakes = [];                //保存蛇坐标
            snakelen = 4;                //蛇身数量
            toGo = 3;
            for( var i = 0; i < snakelen; i++){
                snakes[i] = {x: i * BLOCK_SIZE, y: 0};
            }
            addFood();
            draw();
            oMark.innerHTML = 0;
        }
        //移动函数
        function move(){
            switch(toGo){
                case 1: //左边
                    snakes.push({x: snakes[snakelen - 1].x - BLOCK_SIZE, y: snakes[snakelen - 1].y});
                break;
                case 2: //上边
                    snakes.push({x: snakes[snakelen - 1].x, y: snakes[snakelen - 1].y - BLOCK_SIZE});
                break;
                case 3: //右边
                    snakes.push({x: snakes[snakelen - 1].x + BLOCK_SIZE, y: snakes[snakelen - 1].y});
                break;
                case 4: //下边
                    snakes.push({x: snakes[snakelen - 1].x, y: snakes[snakelen - 1].y + BLOCK_SIZE});
                break;
                default:;
            }
            snakes.shift();
            isEat();
            isDie();
            draw();
        }
        //吃到食物判断
        function isEat(){
            if (snakes[snakelen - 1].x == foodX && snakes[snakelen - 1].y == foodY) {
                oMark.innerHTML = (parseInt(oMark.innerHTML) + 1).toString();
                addFood();
                addSnake();
            }
        }
        //添加蛇身
        function addSnake(){
            snakelen++;
            snakes.unshift({x:BLOCK_SIZE * COLS, y:BLOCK_SIZE * ROWS});
        }
        //交互响应函数
        function keydown(keyCode){
            var _toGo = 1;
                switch(keyCode){
                        case 37: //左边
                                if(toGo != 1 && toGo != 3)  {
                                    _toGo = 1;
                                    make_move(_toGo);
                                }
                                break;
                        case 38: //上边
                                if(toGo != 2 && toGo != 4)        {
                                    _toGo = 2;
                                    make_move(_toGo);
                                }
                                break;
                        case 39: //右边
                                if(toGo != 3 && toGo != 1)         {
                                    _toGo = 3;
                                    make_move(_toGo);
                                }
                                break;
                        case 40: //下的
                                if(toGo != 4 && toGo != 2)        {
                                    _toGo = 4;
                                    make_move(_toGo);
                                }
                                break;
                        case 80: //开始/暂停
                                if(isPause){
                                        interval = setInterval(move,200);
                                        isPause = false;
                                        document.getElementById('pause').innerHTML = "Pause";
                                }else{
                                        clearInterval(interval);
                                        isPause = true;
                                        document.getElementById('pause').innerHTML = "Start";
                                }
                                break;
                }
        }
        //制造食物
        function addFood(){
                foodX = Math.floor(Math.random() * (COLS - 1)) * BLOCK_SIZE;
                foodY = Math.floor(Math.random() * (ROWS - 1)) * BLOCK_SIZE;
                // console.log(foodX + " -- " + foodY);
        }
        //死亡判断
        function isDie(){
                if(snakes[snakelen - 1].x == -20 || snakes[snakelen - 1].x == BLOCK_SIZE * COLS
                        || snakes[snakelen - 1].y == -20 || snakes[snakelen - 1].y == BLOCK_SIZE * ROWS){
                        alert("Game Over!");
                        clearInterval(interval);
                }
                for(var i = 0; i < snakelen - 1; i++){
                        if(snakes[snakelen - 1].x == snakes[i].x && snakes[snakelen - 1].y == snakes[i].y){
                                clearInterval(interval);
                                alert("Game Over!");
                        }
                }
        }
        // 启动函数

        var loginbtn = document.getElementById('login');
        websocket.onmessage = function (e) {
                data = JSON.parse(e.data);
                // console.log(data.event);
                switch (data.event_type) {

                    case 'login_success':
                        user_id = data.player_id;
                        ai_id = "ai_" + user_id;
                        player.textContent = "player_id : " + user_id;
                        alert("login success: " + data.player_id)
                        break;

                    case 'create_room_success':
                        current_room_id = data.room_id;
                        room.textContent = "room_id : " + data.room_id;
                        alert("create room success: " + data.room_id)
                        break;

                    case 'join_room_success':
                        current_room_id = data.room_id;
                        room.textContent = "room_id : " + data.room_id;
                        alert("join room success: " + data.room_id)
                        break;

                    case 'make_move_success':
                        move_info = data.move_info;
                        my_move.textContent = "上一步 : " + data.move_info;
                        break;
                    
                    case 'sync_frame':
                        sync_frame = data.frame_array;
                        // alert("new frame array : " + JSON.stringify(sync_frame));
                        // console.log(JSON.stringify(sync_frame));
                        for (var frame_index = 0; frame_index < sync_frame.length; frame_index++) {
                            console.log("sync_frame: " + JSON.stringify(sync_frame[frame_index]));
                            process_single_frame(sync_frame[frame_index])
                        }
                        break;

                    case 'room_over_success':
                        over_info = data.room_over_info;
                        round.textContent = "本局已结束 : " + data.room_over_info;
                        break;

                    default:
                        console.error(
                            "unsupported event", data);
                }
            };
        //登录
        loginbtn.onclick = function(e){
            websocket.send(JSON.stringify({action: 'login'}));
        }

        var createroombtn = document.getElementById("create_room");
        var joinroombtn = document.getElementById("join_room");
        var startbtn = document.getElementById('start');

        //  开始按钮
        startbtn.onclick = function(e) {
                oMark = document.getElementById('mark_con');
                c = document.getElementById('canvas').getContext('2d');
                start();
                interval = setInterval(move,100);
                document.onkeydown = function(event){
                    var event = event || window.event;
                    keydown(event.keyCode);
                }
        }

        //  创建房间
                createroombtn.onclick = function(e) {
                    // if(!over) {
                    //     alert("game not over")
                    //     return
                    // }
                    if (user_id==null) {
                        alert("not login")
                        return
                    }
                    over = false;
                    var room_id_input = document.getElementById("room_id_input").value
                    console.log(room_id_input);

                    create_action = {action:"create_room",
                                                        player_id:user_id,
                                                        room_name:"new_room",
                                                        room_id:room_id_input};
                    console.log(create_action);
                    websocket.send(JSON.stringify(create_action));
                }

                //  加入房间
                joinroombtn.onclick = function(e) {

                    // if(!over) {
                    //     alert("game not over")
                    //     return
                    // }

                    if (user_id==null) {
                        alert("not login")
                        return
                    }
                    over = false;


                    var room_id_input = document.getElementById("room_id_input").value
                    if (room_id_input==null |  room_id_input.length == 0) {
                        alert("please input room id")
                        return
                    }

                    join_action = {action:"join_room",
                                                        player_id:user_id,
                                                        room_id:room_id_input};

                    console.log(join_action);
                    websocket.send(JSON.stringify(join_action));

                }

                var make_move = function(_toGo) {
                    if(user_id == null) {
                        alert('not login')
                    }
                    if(user_id == null) {
                        alert('not joined room ')
                    }
                    var timestamp = new Date().getTime();
                    make_move_action = {action:"make_move",
                                                        to_go:_toGo,
                                                        player_id:user_id,
                                                        room_id:current_room_id,
                                                        create_request_time:timestamp};
                    console.log(JSON.stringify(make_move_action));
                    websocket.send(JSON.stringify(make_move_action));
                } 



                //  处理服务器同步帧
                var process_single_frame = function(sync_frame) {
                    // console.log(sync_frame['action'])
                    // sync_frame['action'];
                    room_id = sync_frame['room_id'];
                    player_id = sync_frame['player_id'];
                    var _toGo = sync_frame['to_go'];
                    toGo = _toGo;
                }


</script>

</body>
</html> 
