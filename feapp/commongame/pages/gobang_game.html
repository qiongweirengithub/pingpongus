    <!DOCTYPE html>
    <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
            <title>五子棋</title>

            <style type="text/css">
                canvas {
                    display: block;
                    margin: 50px auto;
                    box-shadow: -2px -2px 2px #EFEFEF, 5px 5px 5px #B9B9B9;
                    cursor: pointer;
                }
                .btn-wrap {
                    display: flex;
                    flex-direction: row;
                    justify-content: center;
                }
                .btn-wrap div {
                    margin: 0 10px;
                }
                div>span {
                    display: inline-block;
                    padding: 10px 20px;
                    color: #FFFFFF;
                    background-color: #EE82EE;
                    border-radius: 5px;
                    cursor: pointer;
                }
                div.unable span {
                    background: #D6D6D4;
                    color: #ADACAA;
                }
                #result-wrap {
                    text-align: center;
                }

                .btnwrap{
                    font-family: PingFangSC-Regular;
                    font-size:0.75rem;
                    color: #ffffff;
                    text-align: center;
                    margin-bottom: 1.65rem;
                }

                .bottom{
                    font-family: PingFangSC-Regular;
                    font-size:1rem;
                    color: #ffffff;
                    text-align: center;
                    margin-bottom: 1.65rem;
                    display:inline-block; 
                }

                .input{
                    font-size:0.5rem;
                    color: #ffffff;
                    text-align: center;
                }

                .status {
                    font-size:1rem;
                    color: #afaffa;
                    text-align: center;
                    margin-bottom: 1rem;
                    display:inline-block; 
                }
            </style>
                
            
        </head>
        <body>
            <h3 id="result-wrap">--益智五子棋--</h3>
            <canvas id="chess" width="450px" height="450px"></canvas>

            <span>操作栏</span>
            <div id="btn-box" class="btnwrap">

            <div id="login" class="bottom">
                    <span>登录</span>
            </div>

            <div class="input">
                <span>输入房间id:</span>
                <input type="text" id="room_id_input"> </input>
            </div>
            
            <div id="create_room" class="bottom">
                    <span>创建房间</span>
            </div>

            <div id="join_room" class="bottom">
                    <span>加入房间</span>
            </div>

            <div id="ai_move" class="bottom">
                    <span>AI下棋</span>
            </div>

                <div id="restart" class="bottom">
                    <span>重新开始</span>
                </div>

                <div id="goback" class="bottom unable">
                    <span>悔棋</span>
                </div>
                <div id="return" class="bottom unable">
                    <span>撤销悔棋</span>
                </div>



            </div>
                <span>状态栏</span>

                <div class="status">
                    <span id="round">请落子</span>
                </div>

                <div class="status">
                    <span id="player">not login</span>
                </div>

                <div class="status">
                    <span id="room">not room</span>
                </div>

                <div class="status">
                    <span id="my_move">no move</span>
                </div>


            <script type="text/javascript">

                (function () {
    var html = document.documentElement;
 
    function onWindowResize() {
        html.style.fontSize = html.getBoundingClientRect().width / 20 + 'px';
    }
 
    window.addEventListener('resize', onWindowResize);
    onWindowResize();
})();


                var player = document.getElementById('player');
                var room = document.getElementById('room');
                var my_move = document.getElementById('my_move');
                var round = document.getElementById('round');

                // player = document.querySelector('.player'),
                // room = document.querySelector('.room'),
                // my_move = document.querySelector('.my_move'),

                websocket = new WebSocket("ws://192.168.1.102:8764/");

                websocket.onmessage = function (e) {
                data = JSON.parse(e.data);
                console.log(data.event);
                switch (data.event_type) {

                    case 'login_success':
                        user_id = data.player_id;
                        player.textContent = "player_id : " + user_id;
                        ai_id = "ai_" + user_id;
                        alert("login success: " + data.player_id)
                        break;

                    case 'create_room_success':
                        current_room_id = data.room_id;
                        room.textContent = "room_id : " + data.room_id;
                        my_chess = 1;
                        other_chess = 2;
                        is_creator = true;
                        alert("create room success: " + data.room_id)
                        break;

                    case 'join_room_success':
                        current_room_id = data.room_id;
                        room.textContent = "room_id : " + data.room_id;
                        my_chess = 2;
                        other_chess = 1;
                        is_creator = false;
                        alert("join room success: " + data.room_id)
                        break;

                    case 'make_move_success':
                        move_info = data.move_info;
                        my_move.textContent = "上一步 : " + data.move_info;
                        break;
                    
                    case 'sync_frame':
                        sync_frame = data.frame_array;
                        // alert("new frame array : " + JSON.stringify(sync_frame));
                        console.log(JSON.stringify(sync_frame));
                        for (var frame_index = 0; frame_index < sync_frame.length; frame_index++) {
                            console.log(JSON.stringify(sync_frame[frame_index]));
                            process_single_frame(sync_frame[frame_index])
                        }
                        break;

                    case 'room_over_success':
                        over_info = data.room_over_info;
                        round.textContent = "本局已结束 : " + data.room_over_info;
                        break;

                    case 'users':
                        users.textContent = (
                            data.count.toString() + " user" +
                            (data.count == 1 ? "" : "s"));
                        break;
                    default:
                        console.error(
                            "unsupported event", data);
                }
            };


                var user_id = null;
                var ai_id = null;

                var current_room_id = null;
                var over = false;
                var my_chess = 0;
                var other_chess = 0;
                var is_creator = false;
                var me = true;  //我
                var _nowi = 0, _nowj = 0; //记录自己下棋的坐标
                var _compi = 0, _compj = 0; //记录计算机当前下棋的坐标
                var _myWin = [], _compWin = []; //记录我，计算机赢的情况
                var backAble = false, returnAble = false;
                var resultTxt = document.getElementById("result-wrap");
                var chressBord = []; //棋盘
                for (var i = 0; i < 15; i++) {
                    chressBord[i] = [];
                    for (var j = 0; j < 15; j++) {
                        chressBord[i][j] = 0;
                    }
                }
                //赢法的统计数组
                var myWin = [];
                var computerWin = [];
                //赢法数组
                var wins = [];
                for (var i = 0; i < 15; i++) {
                    wins[i] = [];
                    for (var j = 0; j < 15; j++) {
                        wins[i][j] = [];
                    }
                }
                var count = 0; //赢法总数
                //横线赢法
                for (var i = 0; i < 15; i++) {
                    for (var j = 0; j <11; j++) {
                        for (var k = 0; k < 5; k++) {
                            wins[i][j+k][count] = true;
                        }
                        count++;
                    }               
                }
                 //竖线赢法
                for (var i = 0; i < 15; i++) {
                    for (var j = 0; j <11; j++) {
                        for (var k = 0; k < 5; k++) {
                            wins[j+k][i][count] = true;
                        }
                        count++;
                    }               
                }
                //正斜线赢法
                for (var i = 0; i < 11; i++) {
                    for (var j = 0; j <11; j++) {
                        for (var k = 0; k < 5; k++) {
                            wins[i+k][j+k][count] = true;
                        }
                        count++;
                    }               
                }
                //反斜线赢法
                for (var i = 0; i < 11; i++) {
                    for (var j = 14; j > 3; j--) {
                        for (var k = 0; k < 5; k++) {
                            wins[i+k][j-k][count] = true;
                        }
                        count++;
                    }               
                }
                // debugger;
                for (var i = 0; i < count; i++) {
                    myWin[i] = 0;
                    _myWin[i] = 0;
                    computerWin[i] = 0;
                    _compWin[i] = 0;
                }
                var chess = document.getElementById("chess");
                var context = chess.getContext('2d');
                context.strokeStyle = '#bfbfbf';    //边框颜色
                var loginbtn = document.getElementById("login");
                var room_id_input = document.getElementById("room_id_input");
                var createroombtn = document.getElementById("create_room");
                var joinroombtn = document.getElementById("join_room");
                var aimovebtn = document.getElementById("ai_move");


                var backbtn = document.getElementById("goback");
                var returnbtn = document.getElementById("return");
                window.onload = function() {
                    drawChessBoard(); // 画棋盘
                }
                document.getElementById("restart").onclick = function(){
                    window.location.reload();
                }


                // 我，下棋
                chess.onclick = function(e){
                    if(over){
                        alert("current room is over")
                        return;
                    }
                    if(!me){
                        alert("turn to other")
                        return;
                    }

                    if(user_id == null) {
                        alert("not logined")
                        return
                    }

                    if(current_room_id == null) {
                        alert("not in room")
                        return
                    }
                    // 悔棋功能可用
                    // backbtn.className = backbtn.className.replace(new
                    // RegExp("(\\s|^)unable(\\s|$)")," ");

                    var x = e.offsetX;
                    var y = e.offsetY;
                    var i = Math.floor(x / 30);
                    var j = Math.floor(y / 30);
                    _nowi = i;
                    _nowj = j;


                    make_move_action = {action:"make_move",
                                                                player_id:user_id,
                                                                room_id:current_room_id,
                                                                poxi:_nowi,
                                                                poyi:_nowj}

                    websocket.send(JSON.stringify(make_move_action));
                }

                 //登录
                loginbtn.onclick = function(e){
                    websocket.send(JSON.stringify({action: 'login'}));
                }

                //  创建房间
                createroombtn.onclick = function(e) {
                    // if(!over) {
                    //     alert("game not over")
                    //     return
                    // }
                    if (user_id==null) {
                        alert("not login")
                        return
                    }
                    over = false;
                    var room_id_input = document.getElementById("room_id_input").value
                    console.log(name);
                    create_action = {action:"create_room",
                                                        player_id:user_id,
                                                        room_name:"new_room",
                                                        room_id:room_id_input};
                    console.log(create_action);
                    websocket.send(JSON.stringify(create_action));

                    initChess(); // 画棋盘
                    round.textContent = "请输入";


                }

                //  加入房间
                joinroombtn.onclick = function(e) {

                    // if(!over) {
                    //     alert("game not over")
                    //     return
                    // }

                    if (user_id==null) {
                        alert("not login")
                        return
                    }
                    over = false;


                    var room_id_input = document.getElementById("room_id_input").value
                    if (room_id_input==null |  room_id_input.length == 0) {
                        alert("please input room id")
                        return
                    }

                    join_action = {action:"join_room",
                                                        player_id:user_id,
                                                        room_id:room_id_input};

                    console.log(join_action);
                    websocket.send(JSON.stringify(join_action));

                    initChess(); // 画棋盘
                    round.textContent = "请输入";


                }


                //  ai 下棋
                aimovebtn.onclick = function(e) {
                    computerAI()
                }


                // 悔棋
                backbtn.onclick = function(e){
                    if(!backAble) { return;}
                    over = false;
                    me = true;
                     // resultTxt.innerHTML = 'o(╯□╰)o，悔棋中';
                    // 撤销悔棋功能可用
                    returnbtn.className = returnbtn.className.replace( new
                    RegExp("(\\s|^)unable(\\s|$)")," ");
                    // 我，悔
                    chressBord[_nowi][_nowj] = 0; //我，已占位置 还原
                    minusStep(_nowi, _nowj); //销毁棋子
                    
                    for (var k = 0; k < count; k++) { // 将可能赢的情况都减1
                        if(wins[_nowi][_nowj][k]){
                            myWin[k]--;
                            computerWin[k] = _compWin[k]; //这个位置对方可能赢
                        }
                    }
                     // 计算机相应的悔棋
                    chressBord[_compi][_compj] = 0; //计算机，已占位置 还原
                    minusStep(_compi, _compj);//销毁棋子 
                    
                    for (var k = 0; k < count; k++) {// 将可能赢的情况都减1
                        if(wins[_compi][_compj][k]){
                            computerWin[k]--;
                            myWin[k] = _myWin[i];//这个位置对方可能赢
                        }
                    }
                    resultTxt.innerHTML = '--益智五子棋--';
                    returnAble = true;
                    backAble = false;
                }
                // 撤销悔棋
                returnbtn.onclick = function(e){
                    if(!returnAble){ return;}
                    // 我，撤销悔棋
                    chressBord[_nowi][_nowj] = 1;//我，已占位置
                    oneStep(_nowi,_nowj,me);
                    for (var k = 0; k < count; k++) {
                        if(wins[_nowi][_nowj][k]){
                            myWin[k]++;
                            _compWin[k] = computerWin[k];
                            computerWin[k] = 6;//这个位置对方不可能赢
                        }
                        if(myWin[k] == 5){
                            resultTxt.innerHTML = '恭喜，你赢了！';
                            over = true;
                        }
                    }
                    // 计算机撤销相应的悔棋
                    chressBord[_compi][_compj] = 2;//计算机，已占位置 
                    oneStep(_compi,_compj,false);
                    for (var k = 0; k < count; k++) {// 将可能赢的情况都减1
                        if(wins[_compi][_compj][k]){
                            computerWin[k]++;
                            _myWin[k] = myWin[k];
                            myWin[k] = 6;//这个位置对方不可能赢
                        }
                        if(computerWin[k] == 5){
                            resultTxt.innerHTML = 'o(╯□╰)o，计算机赢了，继续加油哦！';
                            over = true;
                        }
                    }
                    returnbtn.className += '' + 'unable';
                    returnAble = false;
                    backAble = true;
                }
                
                // 计算机下棋
                var computerAI = function(){
                    var myScore = [];
                    var computerScore = [];
                    var max = 0;
                    var u =0, v = 0;
                    for (var i = 0; i < 15; i++) {
                        myScore[i] = [];
                        computerScore[i] = [];
                        for (var j = 0; j < 15; j++) {
                            myScore[i][j] = 0;
                            computerScore[i][j] = 0;
                        }
                    }
                    for (var i = 0; i < 15; i++) {
                        for (var j = 0; j < 15; j++) {
                            if(chressBord[i][j] == 0){
                                for (var k = 0; k < count; k++) {
                                    if(wins[i][j][k]){
                                        if(myWin[k] == 1){
                                            myScore[i][j] += 200;
                                        }else if(myWin[k] == 2){
                                            myScore[i][j] += 400;
                                        }
                                        else if(myWin[k] == 3){
                                            myScore[i][j] += 2000;
                                        }
                                        else if(myWin[k] == 4){
                                            myScore[i][j] += 10000;
                                        }
                                        
                                        if(computerWin[k] == 1){
                                            computerScore[i][j] += 220;
                                        }else if(computerWin[k] == 2){
                                            computerScore[i][j] += 420;
                                        }
                                        else if(computerWin[k] == 3){
                                            computerScore[i][j] += 2100;
                                        }
                                        else if(computerWin[k] == 4){
                                            computerScore[i][j] += 20000;
                                        }
                                    }                                   
                                }
                                
                                if(myScore[i][j] > max){
                                    max = myScore[i][j];
                                    u = i;
                                    v = j;
                                }else if(myScore[i][j] == max){
                                    if(computerScore[i][j]>computerScore[u][v]){
                                        u = i;
                                        v = j;
                                    }
                                }
                                
                                if(computerScore[i][j] > max){
                                    max = computerScore[i][j];
                                    u = i;
                                    v = j;
                                }else if(computerScore[i][j] == max){
                                    if(myScore[i][j]>myScore[u][v]){
                                        u = i;
                                        v = j;
                                    }
                                }
                            }
                        }
                    }
                    _compi = u;
                    _compj = v;

                    ai_make_move_action = {action:"make_move",
                                                                player_id:ai_id,
                                                                room_id:current_room_id,
                                                                poxi:u,
                                                                poyi:v}

                    console.log(ai_make_move_action);
                    websocket.send(JSON.stringify(ai_make_move_action));
                }       
                //绘画棋盘
                var drawChessBoard = function(){
                    for (var i = 0; i < 15; i++) {
                        context.moveTo(15 + i * 30 , 15);
                        context.lineTo(15 + i * 30 , 435);
                        context.stroke();
                        context.moveTo(15 , 15 + i * 30);
                        context.lineTo(435 , 15 + i * 30);
                        context.stroke();
                    }
                }

                //  处理服务器同步帧
                var process_single_frame = function(sync_frame) {
                    console.log(sync_frame['action'])
                    sync_frame['action'];
                    room_id = sync_frame['room_id'];
                    player_id = sync_frame['player_id'];
                    i = sync_frame['poxi'];
                    j = sync_frame['poyi'];
                    u=i;v=j;
                    if(chressBord[i][j] != 0){
                        alert("current position is occupied");
                        return
                    }

                    if(player_id == user_id) {
                        oneStep(i, j, me)
                         chressBord[i][j] = my_chess; //我，已占位置  
                         round.textContent = "请等待对手输入";
                        
                        for (var k = 0; k < count; k++) { // 将可能赢的情况都加1
                            if(wins[i][j][k]){
                                 // debugger;
                                myWin[k]++;
                                _compWin[k] = computerWin[k];
                                computerWin[k] = 6; //这个位置对方不可能赢了
                                if(myWin[k] == 5){
                                    // window.alert('你赢了');
                                    alert ('恭喜，你赢了！');
                                    over = true;
                                }
                            }
                        }
                        if(!over){
                            me = false;
                            // computerAI();
                        }
                    } else {
                        oneStep(u,v,false);
                        chressBord[u][v] = other_chess; //计算机占据位置

                        for (var k = 0; k < count; k++) {
                            if(wins[u][v][k]){
                                computerWin[k]++;
                                _myWin[k] = myWin[k];
                                myWin[k] = 6; //这个位置对方不可能赢了
                                if(computerWin[k] == 5){
                                    alert ('o(╯□╰)o，对方赢了，继续加油哦！');
                                    over = true;
                                }
                            }
                        }
                        round.textContent = "请落子";
                        if(!over){
                            me = true;
                        }
                    }
                    if(over){
                        close_current_room(current_room_id);
                    }

                }


                var close_current_room = function(c_room_id) {
                    room_over_action = {action:"room_over",
                                                                player_id:user_id,
                                                                room_id:current_room_id
                                                                }

                    websocket.send(JSON.stringify(room_over_action));
                }

                //画棋子
                var oneStep = function(i,j,me) {
                    context.beginPath();
                    context.arc(15 +i * 30, 15 + j * 30, 13, 0, 2 * Math.PI);// 画圆
                    context.closePath();
                    //渐变
                    var gradient = context.createRadialGradient(15 + i * 30
                    + 2, 15 + j * 30 - 2, 13, 15 + i * 30 + 2, 15 + j * 30 -
                    2, 0);
                    if(me && is_creator){
                        gradient.addColorStop(0,'#0a0a0a');
                        gradient.addColorStop(1,'#636766');
                    }  else if(!me && is_creator) {
                        gradient.addColorStop(0,'#d1d1d1');
                        gradient.addColorStop(1,'#f9f9f9')                        
                    } else if(me && !is_creator) {
                        gradient.addColorStop(0,'#d1d1d1');
                        gradient.addColorStop(1,'#f9f9f9')                        
                    } else if(!me && !is_creator) {
                        gradient.addColorStop(0,'#0a0a0a');
                        gradient.addColorStop(1,'#636766');
                    } 
                    context.fillStyle = gradient;
                    context.fill();
                }

                var initChess = function() {
                        me = true
                           _nowi = 0, _nowj = 0; //记录自己下棋的坐标
                             _compi = 0, _compj = 0; //记录计算机当前下棋的坐标
                             _myWin = [], _compWin = []; //记录我，计算机赢的情况
                             backAble = false, returnAble = false;
                             resultTxt = document.getElementById("result-wrap");
                             chressBord = []; //棋盘
                            for (var i = 0; i < 15; i++) {
                                chressBord[i] = [];
                                for (var j = 0; j < 15; j++) {
                                    chressBord[i][j] = 0;
                                    minusStep(i,j)
                                }
                            }
                            //赢法的统计数组
                             myWin = [];
                             computerWin = [];
                            //赢法数组
                             wins = [];
                            for (var i = 0; i < 15; i++) {
                                wins[i] = [];
                                for (var j = 0; j < 15; j++) {
                                    wins[i][j] = [];
                                }
                            }
                            var count = 0; //赢法总数
                            //横线赢法
                            for (var i = 0; i < 15; i++) {
                                for (var j = 0; j <11; j++) {
                                    for (var k = 0; k < 5; k++) {
                                        wins[i][j+k][count] = true;
                                    }
                                    count++;
                                }               
                            }
                             //竖线赢法
                            for (var i = 0; i < 15; i++) {
                                for (var j = 0; j <11; j++) {
                                    for (var k = 0; k < 5; k++) {
                                        wins[j+k][i][count] = true;
                                    }
                                    count++;
                                }               
                            }
                            //正斜线赢法
                            for (var i = 0; i < 11; i++) {
                                for (var j = 0; j <11; j++) {
                                    for (var k = 0; k < 5; k++) {
                                        wins[i+k][j+k][count] = true;
                                    }
                                    count++;
                                }               
                            }
                            //反斜线赢法
                            for (var i = 0; i < 11; i++) {
                                for (var j = 14; j > 3; j--) {
                                    for (var k = 0; k < 5; k++) {
                                        wins[i+k][j-k][count] = true;
                                    }
                                    count++;
                                }               
                            }
                            // debugger;
                            for (var i = 0; i < count; i++) {
                                myWin[i] = 0;
                                _myWin[i] = 0;
                                computerWin[i] = 0;
                                _compWin[i] = 0;
                            }
                            drawChessBoard()

                }
                //销毁棋子
                var minusStep = function(i,j){
                     //擦除该圆
                    context.clearRect((i) * 30, (j) * 30, 30, 30);
                    // 重画该圆周围的格子
                    context.beginPath();
                    context.moveTo(15+i*30, j*30);
                    context.lineTo(15+i*30, j*30 + 30);
                    context.moveTo(i*30, j*30+15);
                    context.lineTo((i+1)*30, j*30+15);
                    
                    context.stroke();
                }
            </script>
        </body>
    </html>